{% extends 'base.html' %}
{% block content %}
<div class="container text-center py-4">

<img src="{% url 'generate_qr' order.id %}" class="qr img-fluid" id="qr_code" alt="QR code">
<div class="mt-2">{{ orderCompany }} : {{ orderName }}</div>
    <button class= "btn btn-success mt-3" id="download_pdf">Zapisz PDF (3x8)</button>
    <button class= "btn btn-success mt-3" id="download_qr" onclick="downloadImage()">Zapisz PNG (1)</button>
    <button class= "btn btn-secondary mt-3" onclick="location.href='{% url 'order_detail' order.url %}'">Wróć</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>

<script>
    //decodes txt html issues
    function htmlDecode(input) {
        var doc = new DOMParser().parseFromString(input, "text/html");
        return doc.documentElement.textContent;
      }

     const downloadPDF =  document.getElementById("download_pdf")
     downloadPDF.addEventListener("click", function () {
        
        var orderName = "{{ orderName }}";
        var orderTag = "{{ orderTag }}";
        var orderCompany = "{{ orderCompany }}";
        var doc = new jsPDF('p', 'pt', 'letter');
        doc.setFontSize(6);
        var qrImages = document.querySelectorAll(".qr");
        var qrImageCount = qrImages.length;
        var x = 15, y = 15;
        for (var i = 0; i < qrImageCount * 24; i++) {
            if (i % 3 == 0 && i != 0) {
                y += 95;
                x = 10;
            }
            var imgData = qrImages[i % qrImageCount];
            doc.addImage(imgData, 'PNG', x, y, 170, 70);
            x += 200;
            
            doc.text(x - 170, y + 80,  htmlDecode(orderCompany) + " | " +  htmlDecode(orderName));
        }
        doc.save("QR CODE (3x8)-"+orderCompany+"|"+orderName+".pdf")
        
    });
</script>

<script>

    function downloadImage() {
        // Get the URL of the image from the img element
        var imgElement = document.getElementById('qr_code');
        var imageUrl = imgElement.src;
        var orderName = "{{ orderName }}";
        var orderCompany = "{{ orderCompany }}";

        // Create a new anchor element
        var downloadLink = document.createElement('a');
    
        // Set the href attribute to the URL of the image
        downloadLink.href = imageUrl;
    
        // Set the download attribute to the file name of the image
        downloadLink.download = "QR CODE -"+" "+orderCompany+"-"+orderName+".png"
    
        // Simulate a click on the anchor element to download the image
        downloadLink.click();
    }
   
</script>

{% endblock %}
